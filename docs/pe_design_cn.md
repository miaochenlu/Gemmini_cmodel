# Gemmini 处理单元（PE）设计文档

## 概述

处理单元（Processing Element, PE）是 Gemmini 脉动阵列架构的基本构建模块。每个 PE 执行乘-累加（MAC）运算，这对矩阵乘法和卷积神经网络计算至关重要。

## 模块结构

### 类定义

PE 被实现为一个 C++类，继承自`sparta::Unit`，与 SPARTA 仿真框架集成。

关键组件：

- **端口接口**：管理输入/输出连接
- **事件管理**：处理时序和调度
- **数据处理**：执行实际的 MAC 操作
- **控制逻辑**：管理 PE 状态和操作

### 状态变量

- `weight_`：存储权重值（通常来自权重矩阵）
- `input_`：存储输入数据值（通常来自激活矩阵）
- `output_`：转发到阵列中下一个 PE 的值
- `accumulator_`：累积 MAC 操作的结果
- `busy_`：表示 PE 当前是否正在处理数据
- `cycle_counter_`：跟踪当前操作剩余的周期数

### 参数

- `compute_cycles_`：MAC 操作所需的周期数（当前设置为 0 个周期）
- `data_width_`：PE 处理的数据位宽

## 数据流

### 数据流图

```
                    +----------------------+
                    |                      |
 权重输入     ---->|                      |
 (in_weight)        |                      |
                    |                      |
                    |        PE            |----> 数据输出
 数据输入     ---->|                      |      (out_data)
 (in_data)          |   [累加器]           |
                    |                      |
                    |                      |----> 结果输出
 控制输入     ---->|                      |      (out_result)
 (in_control)       |                      |
                    +----------------------+
```

### 输入路径

1. **权重输入** (`in_weight`)：从权重缓冲区接收权重值
2. **数据输入** (`in_data`)：从前一个 PE 或输入缓冲区接收激活数据
3. **控制输入** (`in_control`)：接收用于操作管理的控制信号

### 输出路径

1. **数据输出** (`out_data`)：将输入数据转发到阵列中的下一个 PE
2. **结果输出** (`out_result`)：在请求时发送累积结果

### 内部数据流

1. 权重存储在 PE 中
2. 输入数据到达并存储
3. 执行 MAC 运算：累加器 += 权重 \* 输入
4. 输入数据转发到下一个 PE
5. 结果可通过结果输出端口在请求时获取

## 时序和周期

### 操作时序

- 每个 MAC 操作需要`compute_cycles_`个周期完成（当前为 0 个周期）
- PE 在内部处理期间设置`busy_`标志
- 由于 MAC 操作为 0 周期，`cycle_counter_`实际上不会递减

### 处理状态

1. **空闲状态**：准备接收新的输入数据
2. **处理状态**：当前正在处理 MAC 操作（但由于是 0 周期，实际上立即完成）
3. **输出状态**：发送累积结果（当被请求时）

### 周期操作详情

1. **周期 0**：接收输入数据和权重，同时执行 MAC 操作
2. **同一周期**：MAC 操作立即完成
3. **周期结束**：PE 返回空闲状态，准备接收下一个输入

### 时序图

```
时钟       : |  0  |  1  |  2  |  3  |  4  |
           : |-----|-----|-----|-----|-----|
权重       : |  W  |     |  W' |     |     |
           : |-----|-----|-----|-----|-----|
数据输入   : |  D  |     |  D' |     |     |
           : |-----|-----|-----|-----|-----|
数据输出   : |  D  |     |  D' |     |     |
           : |-----|-----|-----|-----|-----|
MAC操作    : |  X  |     |  X  |     |     |
           : |-----|-----|-----|-----|-----|
```

_（W/W'=不同权重，D/D'=不同数据输入，X=MAC 操作，由于 MAC 为 0 周期，计算在同一周期内完成）_

## 控制信号

- **重置信号（1）**：将累加器重置为 0
- **读取信号（2）**：请求 PE 输出其累积结果

## 统计信息

- `total_macs_`：计算执行的 MAC 操作数量

## 设计考虑因素

1. **即时计算**：MAC 操作在 0 周期内完成，提高计算效率
2. **数据流水线**：PE 立即转发输入数据，同时完成计算
3. **参数化时序**：虽然当前设置为 0 周期，但设计支持可配置的计算时间
4. **定点算术**：使用 int16_t 作为输入，int32_t 用于累加以防止溢出

## 在脉动阵列中的集成

在完整的脉动阵列中：

- PE 排列成网格
- 权重从上到下流动
- 激活数据从左到右流动
- 结果在每个 PE 内累积
- 计算完成后读取最终结果

### 脉动阵列排列

```
        数据流 →
      +----+----+----+----+
      | PE | PE | PE | PE |
      +----+----+----+----+
 权   | PE | PE | PE | PE |
 重   +----+----+----+----+
 流   | PE | PE | PE | PE |
 向   +----+----+----+----+
 ↓    | PE | PE | PE | PE |
      +----+----+----+----+
```
